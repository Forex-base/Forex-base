<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - All Users</title>
</head>
<body>
  <h2>All Registered Users</h2>

  <!-- Users Table -->
  <table id="users-table" border="1" style="width:100%; margin-bottom:30px;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Balance</th>
        <th>Bonus</th>
        <th>Investments</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Transactions Table -->
  <h2>All Transactions</h2>
  <table id="transactions-table" border="1" style="width:100%; margin-bottom:30px;">
    <thead>
      <tr>
        <th>User Email</th>
        <th>Type</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Details</th>
        <th>Timestamp</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="adminTransactionBody"></tbody>
  </table>

  <!-- Add Transaction Form -->
  <h2>Add New Transaction</h2>
  <form id="addTransactionForm" style="margin-bottom:30px;">
    <input id="userEmail" placeholder="User Email" required />
    <select id="type" required>
      <option value="Deposit">Deposit</option>
      <option value="Withdrawal">Withdrawal</option>
      <option value="Investment">Investment</option>
    </select>
    <input id="amount" type="number" step="0.01" placeholder="Amount" required />
    <select id="status" required>
      <option value="Pending">Pending</option>
      <option value="Completed">Completed</option>
      <option value="Rejected">Rejected</option>
    </select>
    <input id="details" placeholder="Details (optional)" />
    <button type="submit">Add Transaction</button>
  </form>

  <script>
    async function fetchUsers() {
      try {
        const res = await fetch('/api/auth/all');
        const users = await res.json();
        const tbody = document.querySelector('#users-table tbody');
        tbody.innerHTML = '';

        users.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.fullName}</td>
            <td>${user.email}</td>
            <td>${user.phone}</td>
            <td>
              $${user.balance}
              <br/>
              <input type="number" id="balance-${user._id}" placeholder="New balance" />
              <button onclick="updateBalance('${user._id}')">Update</button>
            </td>
            <td>
              $${user.bonus}
              <br/>
              <input type="number" id="bonus-${user._id}" placeholder="New bonus" />
              <button onclick="updateBonus('${user._id}')">Update</button>
            </td>
            <td>
              ${(user.investments || []).map(inv => `
                <div>
                  <strong>${inv.plan}</strong> - $
                  <input type="number" id="inv-${user._id}-${inv._id}" value="${inv.amount}" style="width:70px;" />
                  <button onclick="updateInvestment('${user._id}', '${inv._id}')">Update</button>
                </div>
              `).join('')}
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to load users.');
      }
    }

    async function updateBalance(userId) {
      const value = document.getElementById(`balance-${userId}`).value;
      if (!value) return alert("Enter balance amount");

      const res = await fetch(`/api/users/${userId}/balance`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ balance: parseFloat(value) })
      });
      const data = await res.json();
      if (res.ok) {
        alert('Balance updated');
        fetchUsers();
      } else {
        alert(data.message);
      }
    }

    async function updateBonus(userId) {
      const value = document.getElementById(`bonus-${userId}`).value;
      if (!value) return alert("Enter bonus amount");

      const res = await fetch(`/api/users/${userId}/bonus`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bonus: parseFloat(value) })
      });
      const data = await res.json();
      if (res.ok) {
        alert('Bonus updated');
        fetchUsers();
      } else {
        alert(data.message);
      }
    }

    async function updateInvestment(userId, investmentId) {
      const amount = parseFloat(document.getElementById(`inv-${userId}-${investmentId}`).value);
      if (isNaN(amount)) return alert("Enter valid amount");

      const res = await fetch(`/api/users/${userId}/investments/${investmentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount })
      });
      const data = await res.json();
      if (res.ok) {
        alert('Investment updated');
        fetchUsers();
      } else {
        alert(data.message);
      }
    }

    async function fetchTransactions() {
      try {
        const res = await fetch('/api/transactions');
        const transactions = await res.json();
        const tbody = document.getElementById('adminTransactionBody');
        tbody.innerHTML = '';

        transactions.forEach(tx => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${tx.userEmail}</td>
            <td>${tx.type}</td>
            <td><input id="amount-${tx._id}" type="number" value="${tx.amount}" /></td>
            <td><input id="status-${tx._id}" value="${tx.status}" /></td>
            <td><input id="details-${tx._id}" value="${tx.details || ''}" /></td>
            <td>${new Date(tx.timestamp).toLocaleString()}</td>
            <td>
              <button onclick="updateTransaction('${tx._id}')">Save</button>
              <button onclick="deleteTransaction('${tx._id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        alert('Failed to fetch transactions');
      }
    }

    async function updateTransaction(id) {
      const amount = parseFloat(document.getElementById(`amount-${id}`).value);
      const status = document.getElementById(`status-${id}`).value;
      const details = document.getElementById(`details-${id}`).value;

      const res = await fetch(`/api/transactions/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount, status, details })
      });

      if (res.ok) {
        alert('Transaction updated');
      } else {
        alert('Update failed');
      }
    }

    async function deleteTransaction(id) {
      if (!confirm('Are you sure you want to delete this transaction?')) return;

      const res = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
      if (res.ok) {
        alert('Transaction deleted');
        fetchTransactions();
      } else {
        alert('Delete failed');
      }
    }

    document.getElementById('addTransactionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userEmail = document.getElementById('userEmail').value;
      const type = document.getElementById('type').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const status = document.getElementById('status').value;
      const details = document.getElementById('details').value;

      const res = await fetch('/api/transactions/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userEmail, type, amount, status, details })
      });

      if (res.ok) {
        alert('Transaction added');
        fetchTransactions();
      } else {
        const data = await res.json();
        alert('Error: ' + data.message);
      }
    });

    // Initialize
    fetchUsers();
    fetchTransactions();
  </script>
</body>
</html>
